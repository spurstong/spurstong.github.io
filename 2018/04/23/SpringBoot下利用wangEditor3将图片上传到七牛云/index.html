<!DOCTYPE html><html lang="zh-cn"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> SpringBoot下利用wangEditor3将图片上传到七牛云 · 房东的小黑</title><meta name="description" content="SpringBoot下利用wangEditor3将图片上传到七牛云 - Mara Tong"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://github.com/spurstong/atom.xml" title="房东的小黑"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/black.jpg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/tags/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://www.jianshu.com/u/a8d49bf62c45" target="_blank" class="nav-list-link">JIANSHU</a></li><li class="nav-list-item"><a href="https://github.com/spurstong" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">SpringBoot下利用wangEditor3将图片上传到七牛云</h1><div class="post-info">2018年4月23日</div><div class="post-content"><p>wangEditor3一般将图片上传到服务器很便捷，网上也有很多方法，但官方文档中给出的上传到七牛云的方法没领悟到什么意思，尝试了几次，没有成功，我就采取了一种折中的方法，即利用图片上传服务器的方法上传到七牛云。</p>
<blockquote>
<p>首先在网页中配置wangEditor图片上传</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> E = window.wangEditor;</span><br><span class="line">    <span class="keyword">var</span> editor = <span class="keyword">new</span> E(<span class="string">'#div1'</span>, <span class="string">'#div2'</span>);  <span class="comment">// 两个参数也可以传入 elem 对象，class 选择器</span></span><br><span class="line">    editor.customConfig.debug = <span class="keyword">true</span>;</span><br><span class="line">    editor.customConfig.uploadImgServer = <span class="string">'/post/upload'</span>;</span><br><span class="line">    editor.customConfig.uploadFileName = <span class="string">'multiple'</span>;  &lt;-   与后台获取文件名相同</span><br><span class="line">    editor.create();</span><br></pre></td></tr></table></figure>

<blockquote>
<p>创建结果返回类，wangEditor要求返回json信息</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Result</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer errno;</span><br><span class="line">    <span class="keyword">private</span> String[] data;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getErrno</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> errno;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setErrno</span><span class="params">(Integer errno)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.errno = errno;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String[] getData() &#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(String[] data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//wangEditor图片上传返回数据</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResultUtil</span> </span>&#123;</span><br><span class="line"> <span class="comment">//上传成功</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Result <span class="title">success</span><span class="params">(String[] object)</span> </span>&#123;</span><br><span class="line">        Result result = <span class="keyword">new</span> Result();</span><br><span class="line">        result.setErrno(<span class="number">0</span>);</span><br><span class="line">        result.setData(object);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="comment">//上传失败</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Result <span class="title">success</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>七牛云上传工具类 </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Qiniu</span> </span>&#123;</span><br><span class="line">    Logger logger = LogManager.getLogger(LogManager.ROOT_LOGGER_NAME);</span><br><span class="line">  <span class="comment">//从springboot的application.properties文件获取你注册的七牛云有关信息  </span></span><br><span class="line">  <span class="meta">@Value</span>(<span class="string">"$&#123;qiniu.accessKey&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String accessKey;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;qiniu.secretKey&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String secretKey;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;qiniu.bucket&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String bucket;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;qiniu.path&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String path;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">uploadToken</span><span class="params">(FileInputStream file, String key)</span> </span>&#123;</span><br><span class="line">        Configuration cfg = <span class="keyword">new</span> Configuration(Zone.zone1());</span><br><span class="line">        UploadManager uploadManager = <span class="keyword">new</span> UploadManager(cfg);</span><br><span class="line">        logger.info(<span class="string">"path="</span> + path);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Auth auth = Auth.create(accessKey, secretKey);</span><br><span class="line">            String upToken = auth.uploadToken(bucket);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Response response = uploadManager.put(file, key, upToken, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">              <span class="comment">//  DefaultPutRet putRet = JSON.parseObject(response.bodyString(), DefaultPutRet.class);</span></span><br><span class="line">                DefaultPutRet putRet = <span class="keyword">new</span> Gson().fromJson(response.bodyString(), DefaultPutRet.class);</span><br><span class="line">                logger.info(<span class="string">"key:"</span> + putRet.key);</span><br><span class="line">                String encodedFileName = URLEncoder.encode(putRet.key, <span class="string">"utf-8"</span>);</span><br><span class="line">                <span class="comment">//获取下载地址,前天可以通过img访问</span></span><br><span class="line">                String finalUrl = String.format(<span class="string">"%s/%s"</span>, path, encodedFileName);</span><br><span class="line">                logger.info(<span class="string">"访问地址:"</span> + finalUrl);</span><br><span class="line">                <span class="keyword">return</span> finalUrl;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (QiniuException ex) &#123;</span><br><span class="line">                Response r = ex.response;</span><br><span class="line">                System.err.println(r.toString());</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.err.println(r.bodyString());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (QiniuException ex2) &#123;</span><br><span class="line">                    <span class="comment">//ignore</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在springmvc进行文件处理</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/post"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PostController</span> </span>&#123;</span><br><span class="line">     <span class="meta">@Resource</span></span><br><span class="line">     <span class="keyword">private</span> Qiniu qiniu;</span><br><span class="line">     <span class="comment">//帖子上传图片到服务器 MultipartFile   multiple,与网页设置的名字相同</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/upload"</span>, method = RequestMethod.POST)</span><br><span class="line">    <span class="keyword">public</span> <span class="meta">@ResponseBody</span> <span class="function">Result <span class="title">uploadImageHtml</span><span class="params">(MultipartFile multiple, HttpSession session, HttpServletRequest request)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (multiple != <span class="keyword">null</span>) &#123;</span><br><span class="line">            FileInputStream inputStream = (FileInputStream) multiple.getInputStream();</span><br><span class="line">            String fileName = multiple.getOriginalFilename();</span><br><span class="line">           <span class="comment">//下一句主要是创建文件名，我程序中还用到了springsecurity,你可以根据需要命名</span></span><br><span class="line">            User user = (User) SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span><br><span class="line">            String fileNameExtension = fileName.substring(fileName.lastIndexOf(<span class="string">"."</span>), fileName.length());</span><br><span class="line">            String realName = String.valueOf(System.currentTimeMillis()) + user.getUsername()  + fileNameExtension;</span><br><span class="line">            String path = qiniu.uploadToken(inputStream, realName);</span><br><span class="line">            String [] str = &#123;path&#125;;</span><br><span class="line">            <span class="keyword">return</span> ResultUtil.success(str);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ResultUtil.success();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></article></div></main><footer><div class="paginator"><a href="/2018/05/19/Python 函数参数作为引用时/" class="prev">上一篇</a></div><div class="copyright"><p>© 2015 - 2019 <a href="https://github.com/spurstong">Mara Tong</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>